```{r include=FALSE}
pacman::p_load(dplyr,sjmisc,car,sjlabelled,labelled,stargazer,kableExtra,corrplot,sessioninfo,readxl,
               pander,xtable,tidyverse,extrafont,ggplot2,forcats,ggpubr,naniar,haven,devtools,
               summarytools,poLCA,sjPlot,lavaan,knitr,summarytools,psych)
load("Input/Data_proc/data.RData")

data %>% 
  dplyr::select(atrib_pob_1,atrib_pob_2,atrib_pob_3,atrib_pob_4,atrib_pob_5,
                atrib_riq_1,atrib_riq_2,atrib_riq_3,atrib_riq_4,atrib_riq_5) -> atribcor

data %>% 
  dplyr::select(merit_perc_effort,merit_perc_talent,merit_perc_wpart,merit_perc_netw, 
                merit_pref_effort,merit_pref_talent,merit_pref_wpart,merit_pref_netw) -> meritcor
```
```{r include=FALSE}
table_format = if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex"
}

table_format2 = if(is_html_output()) {
  T
} else if(is_latex_output()) {
  F
}
fa_table <- function(x, cut) {
  #get sorted loadings
  loadings <- fa.sort(x)$loadings %>% round(3)
  #supress loadings
  loadings[loadings < cut] <- ""
  #get additional info
  add_info <- cbind(x$communality, 
                    x$uniquenesses,
                    x$complexity) %>%
    # make it a data frame
    as.data.frame() %>%
    # column names
    rename("Communality" = V1,
           "Uniqueness" = V2,
           "Complexity" = V3) %>%
    #get the item names from the vector
    rownames_to_column("item")
  #build table
  loadings %>%
    unclass() %>%
    as.data.frame() %>%
    rownames_to_column("item") %>%
    left_join(add_info) %>%
    mutate(across(where(is.numeric), round, 3))
}
```



# Análisis

## Análisis descriptivo

<div style="text-align: justify">


```{r tab-desc, echo=FALSE,results='asis'}
print(dfSummary(data, headings=FALSE, valid.col = FALSE, na.col = FALSE, varnumbers = FALSE,
                col.widths = c(170,  # variable
                              160,  # label
                              190, # stats/Values 
                              130, # freqs
                              130 # graph 
                              ),graph.magnif = 0.97),
      max.tbl.height = 800,
      method="render")
```

La Tabla anterior presenta los estadísticos descriptivos de las variables con las que se trabaja. Al observar las respuestas para los cuatro indicadores para las atribuciones de pobreza, se da cuenta de distintas distribuciones entre ellas. En primer lugar, la explicación de las causas de la pobreza a partir de la Falta de habilidad muestra una gran concentración de respuestas en la categoría 3 (48,8%), es decir, con la respuesta "Ni de acuerdo ni en desacuerdo". Además, muestra una distribución similar a la distribución normal. En cuanto a la explicación de las causas de la pobreza a partir de la Mala suerte, los resultados se agrupan en las tres primeras respuestas, es decir, entre (1) "Totalmente en desacuerdo" y (3) "Ni de acuerdo ni en desacuerdo", con un mayor porcentaje para esta última (35,1%). En cuanto a las atribuciones de pobreza explicadas por la Falta de esfuerzo, al igual que con la de Falta de habilidad, la respuesta 3 agrupa la mayoría de los casos (41,9%), mostrando igualmente una distribución similar a la distribución normal. En cuanto a la explicación de las causas de la pobreza a partir del Sistema económico y del Sistema educativo, en ambos indicadores se observa que la mayoría de los casos se concentran en las respuestas 4 y 5, es decir, "De acuerdo" y "Totalmente de acuerdo", siendo para el indicador de Sistema económico un 30,9% en "De acuerdo" y 46,7% en "Totalmente de acuerdo", mientras que para la explicación por el Sistema educativo los porcentajes son de 36,9% en "De acuerdo" y 44,8% en "Totalmente de acuerdo".

Respecto a las atribuciones de riqueza, se observa que la explicación de las causas de la riqueza a partir del Talento, Suerte y Trabajo duro se concentran en "Ni de acuerdo ni en desacuerdo", con un 44,9%, 39% y 37,5%, respectivamente. Para los indicadores de Sistema económico y Sistema educativo la mayoría de los casos se agrupan en "De acuerdo" y "Totalmente de acuerdo", siendo de un 29,4% y 47,8% para el primero, mientras que para el segundo de un 27,4% y 39,1%. 

Más abajo en la misma Tabla se encuentran las variables independientes, distinguiéndose los cuatro indicadores para el grupo de percepciones meritocráticas, y cuatro para el grupo de preferencias meritocráticas. En el primer grupo, los indicadores de "[se] Obtienen mayores recompensa [por el] Esfuerzo", "Logran salir adelante [quienes tienen] Padres ricos" y "Logran salir adelante [quienes tienen] buenos contactos" concentran la mayoría de los casos en "De acuerdo" y "Totalmente de acuerdo", siendo para el indicador de Esfuerzo 25,1% y 30,9%, para Padres ricos 29,7% y 35,6% y para Buenos contactos 36,9% y 33,8%, respectivamente. Por su parte, el indicador de "[se] Obtienen mayores recompensa [por el] Talento" concentra los casos en "Ni de acuerdo ni en desacuerdo" con 33,8%, mostrando una distribución relativamente normal. En cuanto a las preferencias meritocráticas, el indicador de "[se] Deberían obtener mayores recompensas [por el] Esfuerzo" concentra más de la mitad de los casos en "Totalmente de acuerdo", con un 54,3%. Los indicadores de  "[se] Deberían obtener mayores recompensas [por el] Esfuerzo", "Esta bien que salgan adelante [quienes tienen] Padres ricos" y "Esta bien que salgan adelante [quienes tienen] Buenos contactos" concentran sus casos en "Ni de acuerdo ni en desacuerdo", con un 30,3%, 31,7% y 31,5%, respectivamente. Cabe destacar que el indicador de preferencias meritocráticas basado en el Talento tiene una gran cantidad de casos en "De acuerdo" y "Totalmente de acuerdo", lo cual, junto con el indicador de Esfuerzo, muestra un alto consenso respecto a estar de acuerdo con preferencias basadas en el mérito.  

## Modelo de medición para Atribuciones de pobreza y riqueza

### Modelos de correlación

A continuación se presentan las Figuras N° \@ref(fig:matpearson_dep) y  N° \@ref(fig:matpolycor_dep), las cuales muestran las correlaciones de Person y policloricas, respectivamente, de la variable dependiente, referente a las atribuciones de pobreza y riqueza. Tanto en las correlaciones de Pearson como en las correlaciones policloricas, es posible identificar un primer grupo a partir de correlaciones positivas de niveles medios y medios-altos, en donde se encuentran las Atribuciones de pobreza por Falta de habilidad, Atribuciones de pobreza por Falta de esfuerzo, Atribuciones de riqueza a partir del Talento y Atribuciones de riqueza a partir del Trabajo duro. Cada una de ellas correlaciona entre sí de manera positiva y con niveles medios-altos, en donde destacan los niveles de correlación entre los dos indicadores correspondientes a las atribuciones de pobreza (por Falta de habilidad y por Falta de esfuerzo) y, por el otro lado, entre los dos indicadores de atribuciones de riqueza (por Talento y Trabajo duro). Por otro lado, se identifica otro grupo que correlaciona de manera positiva y con niveles medios y medios-altos entre Atribuciones de pobreza a partir del Sistema económico, Atribuciones de pobreza a partir del Sistema educativo, Atribuciones de riqueza a partir del Sistema económico y Atribuciones de riqueza a partir del Sistema educativo. Cabe destacar que los indicadores del primer grupo, coincidentes con lo que en la literatura se le ha llamado "atribuciones internas", correlacionan de manera negativa con los indicadores del segundo grupo, al cual se le puede denominar, a partir de la literatura, "atribuciones externas". Por último,las Atribuciones de pobreza por Mala suerte y Atribuciones de riqueza por Suerte, muestran una correlación positiva y media-alta solamente entre ellas, lo cual daría cuenta sobre un tercer constructo. Sin embargo, antes de anticiparnos a los constructos, es necesario realizar análisis factoriales.


```{r matpearson_dep, echo=FALSE, fig.cap="Matriz de Correlaciones de Pearson  para Atribuciones de pobreza y riqueza", fig.align = 'center', out.width = '100%'}
pearson_atrib=cor(atribcor, use = "complete.obs")
windowsFonts(A = windowsFont("Times New Roman"))
rownames(pearson_atrib) <-c(
  "(1) Atribuciones pobreza Falta habilidad",
  "(2) Atribuciones pobreza Mala suerte",
  "(3) Atribuciones pobreza Falta esfuerzo",
  "(4) Atribuciones pobreza Sistema económico",
  "(5) Atribuciones pobreza Sistema educativo",
  "(6) Atribuciones riqueza Talento",
  "(7) Atribuciones riqueza Suerte",
  "(8) Atribuciones riqueza Trabajo duro",
  "(9) Atribuciones riqueza Sistema económico",
  "(10) Atribuciones riqueza Sistema educativo")
colnames(pearson_atrib) <-c("(1)", "(2)","(3)","(4)","(5)", "(6)","(7)","(8)","(9)","(10)")
corrplot(pearson_atrib,
         method = "color",
         type = "upper",
         tl.col = "black",
         addCoef.col = "black",
         diag = TRUE,
         family = "A",
         number.font = 6,
         tl.cex =0.75,
         number.cex = 1)
```

```{r matpolycor_dep, echo=FALSE, fig.cap="Matriz de Correlaciones Policlorica para Atribuciones de pobreza y riqueza", fig.align = 'center', out.width = '100%'}
polycor_atrib <- psych::polychoric(atribcor)
windowsFonts(A = windowsFont("Times New Roman"))
rownames(polycor_atrib$rho) <-c(
  "(1) Atribuciones pobreza Falta habilidad",
  "(2) Atribuciones pobreza Mala suerte",
  "(3) Atribuciones pobreza Falta esfuerzo",
  "(4) Atribuciones pobreza Sistema económico",
  "(5) Atribuciones pobreza Sistema educativo",
  "(6) Atribuciones riqueza Talento",
  "(7) Atribuciones riqueza Suerte",
  "(8) Atribuciones riqueza Trabajo duro",
  "(9) Atribuciones riqueza Sistema económico",
  "(10) Atribuciones riqueza Sistema educativo"
  )
colnames(polycor_atrib$rho) <-c("(1)", "(2)","(3)","(4)","(5)", "(6)","(7)","(8)","(9)","(10)")
corrplot(polycor_atrib$rho,
  method = "color",
  type = "upper",
  tl.col = "black",
  addCoef.col = "black",
  diag = TRUE,
  number.font = 6,
  tl.cex =0.75,
  number.cex = 1)
```

### Analisis Factorial Exploratorio (AFE)

<div style="text-align: justify">

Como se señala en el libro de @_confirmatory_2007, el modelo de Análisis factorial exploratorio escencialmente es un análisis en donde se pretende identificar la covarianza y varianza dentro de un conjunto de datos u observaciones. Es decir, se busca identificar la relación entre medidas observables o indicadores a partir de una variable latente o factor, siendo esta última una variable inobservable. AFE es levemente distinto al Análisis del componente principal (PCA por sus siglas en inglés), en donde el primero puede hacer lo mismo que el Análisis del componente principal, pero no viceversa. Mientras PCA tiende a ser más exploratorio, el Análisis factorial requiere más suposiciones y es un poco más restrictivo en cuanto a sus suposiciones, como normalidad y relaciones lineales entre sus variables. 

Para saber si se puede proceder a un Análisis factorial exploratorio sobre las variables dependientes, se realizó un test de normalidad, del determinante y KMO. Para el test de normalidad se realizaron pruebas de Lilliefors (Kolmogorov-Smirnov) y Jarque Bera, en donde ambos test presentaron valores *p* > *0.01*, descartando el supuesto de normalidad. Hubo dos excepciones, en donde las variables de Atribución de pobreza por Falta de habilidad y Atribución de riqueza por Talento presentaron valores *p* < *0.01*, cumpliendo con el supuesto de normalidad. Por su parte, el cálculo del determinante es de 0.1188577. Este valor es mayor que el valor necesario de 0.00001, por lo que el determinante no parece problemático. Por último, el resultado para KMO es de 0.67. Aún considerándose un resultado bajo, es posible continuar con el AFE.

Posteriormente, se procede a analizar los eigenvalores, el cual mide cuánta varianza de los indicadores es explicada por el (los) factor(es), siendo ≥ 1 cuando el factor logra explicar más que el indicador por si mismo. En este caso, el análisis muestra que dos factores logran explicar más que los indicadores por sí solos, por lo que se comienza el AFE a partir de dos factores, para luego comparar con modelos de más factores. 

La tabla N° \@ref(tab:f2t) muestra los resultados para el modelo AFE de dos factores. Este muestra cargas factoriales consistentes con la literatura, distinguiendo entre atribuciones internas y atribuciones externas. Las cargas del grupo de atribuciones internas, referentes al esfuerzo y talento, muestran cargas sobre 0.6-. Si bien los indicadores fatalistas o de suerte pertenecerían a las atribuciones internas -por mostrar cargas mayores en este factor que en el factor de atribuciones externas-, sus cargas son muy bajas, entre 0.25 y 0.3, dificultando la tarea de ubicar a estos dos indicadores en atribuciones internas o atribuciones externas. Por otro lado, las cargas del grupo de atribuciones externas, muestran cargas sobre 0.5, a excepción de las Atribuciones de riqueza por Sistema económico, el cual da 0.43. Por su parte, la tabla N° \@ref(tab:f3t) muestra el modelo de tres factores. Las cargas factoriales en este caso indican la existencia de tres factores, siendo estos de atribuciones internas, externas y fatalistas. En general, las cargas factoriales aumentan en casi todos los indicadores, siendo especialmente importante para las atribuciones fatalistas o de suerte, las cuales muestran valores sobre 0.55. 

Los modelos AFE coinciden con lo señalado por la literatura. Por un lado, el modelo de dos factores coincide con investigaciones que indican la existencia de dos factores, siendo estos de atribuciones internas-individualistas y atribuciones externas-estructuralistas, en donde los indicadores de suerte se comportan de manera ambigua a la hora de ubicarlos en atribuciones internas o externas, representando, posiblemente, dimensiones híbridas, tal como apunta @bullock_predicting_2003. Por otro lado, el modelo de tres factores mejora las cargas factoriales, y vendría a indicar la existencia de un tercer factor o grupo referente a las atribuciones fatalistas, en línea de lo planteado por @feaginj.r_subordinating_1975, siendo esta una investigación pionera respecto a atribuciones de pobreza, como también en investigaciones posteriores [@feather_explanations_1974; @hunt_race_2004]. Si bien el Análisis factorial exploratorio indica la presencia de dos factores, en donde los indicadores de suerte no serían explicados por estos dos factores, al generar un modelo de tres factores este hace sentido con parte de la literatura sobre atribuciones, en donde los tres factores logran explicar los indicadores de manera satisfactoria. Para determinar la composición de los factores y el número de ellos, se procede al Análisis factorial confirmatorio (CFA).

```{r f2t, echo=FALSE, message=FALSE, warning=FALSE}
f2_table <- fa_table(fa_pa.2_fatal, -10)
rownames(f2_table)  <- c("Atribuciones riqueza Talento","Atribuciones pobreza Falta esfuerzo","Atribuciones riqueza Trabajo duro","Atribuciones pobreza Falta habilidad","Atribuciones pobreza Mala suerte","Atribuciones riqueza Suerte","Atribuciones pobreza Sistema económico","Atribuciones pobreza Sistema educativo","Atribuciones riqueza Sistema económico","Atribuciones riqueza Sistema educativo")
f2_table <- select(f2_table, -item)
knitr::kable(f2_table,
             caption = "Cargas factoriales Modelo 2 Factores")
```

```{r f3t, echo=FALSE, message=FALSE, warning=FALSE}
f3_table <- fa_table(fa_pa.3, -10)
rownames(f3_table)  <- c("Atribuciones riqueza Trabajo duro","Atribuciones riqueza Talento","Atribuciones pobreza Falta esfuerzo","Atribuciones pobreza Falta habilidad","Atribuciones pobreza Sistema económico","Atribuciones pobreza Sistema educativo","Atribuciones riqueza Sistema económico","Atribuciones riqueza Sistema educativo","Atribuciones pobreza Mala suerte","Atribuciones riqueza Suerte")
f3_table <- select(f3_table, -item)
knitr::kable(f3_table,
             caption = "Cargas factoriales Modelo 3 Factores")
```


### Análisis factorial confirmatorio 


## Modelo de medición para Percepciones y Preferencias meritocráticas

### Modelos de correlación

Las Figuras N° \@ref(fig:matpearson_indep) y  N° \@ref(fig:matpolycor_indep) muestran las correlaciones de Pearson y policloricas respectivamente, en donde se observa que los valores medios-altos, especificamente, correlaciones en torno al valor 0.5, se dan entre (1) [se] Obtienen mayores recompensas por el Esfuerzo y [se] Obtienen mayores recompensas por el Talento, (2) Logran a salir adelante [quienes tienen] Padres ricos y Logran a salir adelante [quienes tienen] buenos contactos, (3) Deberían obtener mayores recompensas [quienes] se Esfuerzan y Deberían tener mayores recompensas [quienes tienen] Talento y (4) Está bien que salgan adelante [quienes tienen] Padres ricos y Está bien que salgan adelante [quienes tienen] Buenos contactos. De esta forma, es posible subdividir en cuatro grupos, a los cuales se les puede llamar de (1) Percepción meritocráctica, (2) Percepción no-meritocrática, (3) Preferencias meritocráticas y (4) Preferencias no-meritocráticas. Además, existen correlaciones bajas-medias distinguibles entre varias de los indicadores de carácter meritocrático, ya sean del grupo de Percepciones o del de Preferencias, no así entre indicadores de carácter no-meritocrático. La categorización que se logra distinguir a partir del modelo de correlación coincide con la literatura [@Castillo2020] en cuanto a la existencia de cuatro sub-grupos y que las variables meritocráticas no son necesariamente opuestas a las no-meritocráticas al no existir grandes niveles de correlación negativa e incluso presentando ciertos niveles de correlación entre indicadores meritocráticos y no-meritocráticos. Debido a los resultados que se obtuvieron a partir de los modelos de correlación y a la literatura existente que señala la posibilidad de subdividir en percepciones y preferencias merticoráticas y no-meritocráticas [@castillo_meritocracia_2019a; @Castillo2020; @Iturra2019] es que se procede a un Análisis Factorial Confirmatorio (CFA) para poner a prueba la viabilidad de los cuatro constructos. 


```{r matpearson_indep, echo=FALSE, fig.cap="Matriz de Correlaciones de Pearson para Percepciones y Preferencias meritocráticas", fig.align = 'center', out.width = '100%'}
# Correlación de pearson

pearson_merit=cor(meritcor, use = "complete.obs")
windowsFonts(A = windowsFont("Times New Roman"))
rownames(pearson_merit) <-c(
  "(1) Obtienen mayores recompensas: Esfuerzo",
  "(2) Obtienen mayores recompensas: Talento",
  "(3) Logran salir adelante: Padres ricos",
  "(4) Logran salir adelante: Buenos contactos",
  "(5) Deberían obtener mayores recompensas: Esfuerzo",
  "(6) Deberían obtener mayores recompensas: Talento",
  "(7) Esta bien que salgan adelante: Padres ricos",
  "(8) Esta bien que salgan adelante: Buenos contactos")
colnames(pearson_merit) <-c("(1)", "(2)","(3)","(4)","(5)", "(6)","(7)","(8)")
corrplot(pearson_merit,
         method = "color",
         type = "upper",
         tl.col = "black",
         addCoef.col = "black",
         diag = TRUE,
         family = "A",
         number.font = 6,
         tl.cex =0.75,
         number.cex = 1)
```

```{r matpolycor_dep, echo=FALSE, fig.cap="Matriz de Correlaciones Policlorica para Percepciones y Preferencias meritocráticas", fig.align = 'center', out.width = '100%'}
# Correlación policlorica 

polycor_merit <- psych::polychoric(meritcor)
windowsFonts(A = windowsFont("Times New Roman"))
rownames(polycor_merit$rho) <-c(
  "(1) Obtienen mayores recompensas: Esfuerzo",
  "(2) Obtienen mayores recompensas: Talento",
  "(3) Logran salir adelante: Padres ricos",
  "(4) Logran salir adelante: Buenos contactos",
  "(5) Deberían obtener mayores recompensas: Esfuerzo",
  "(6) Deberían obtener mayores recompensas: Talento",
  "(7) Esta bien que salgan adelante: Padres ricos",
  "(8) Esta bien que salgan adelante: Buenos contactos")
colnames(polycor_merit$rho) <-c("(1)", "(2)","(3)","(4)","(5)", "(6)","(7)","(8)")
corrplot(polycor_merit$rho,
         method = "color",
         type = "upper",
         tl.col = "black",
         addCoef.col = "black",
         diag = TRUE,
         number.font = 6,
         tl.cex =0.75,
         number.cex = 1)

```


### Análisis Factorial Confirmatorio



```{r tab-cfa-indep, echo=FALSE, fig.cap="Matriz de Correlaciones Policlorica para Percepciones y Preferencias meritocráticas", fig.align = 'center', out.width = '100%'}

m_merit.4<-'
perc_merit=~merit_perc_effort+merit_perc_talent
pref_merit=~merit_pref_talent+merit_pref_effort
perc_nmerit=~merit_perc_wpart+merit_perc_netw
pref_nmerit=~merit_pref_netw+merit_pref_wpart
'


m_merit.4.fit<-cfa(m_merit.4,data=data,estimator="MLR")
#Continuous/ estimator ML Robust
m_merit.4_ord.fit <- cfa(model = m_merit.4,data = data,ordered = c("merit_perc_effort","merit_perc_talent",
                                                          "merit_perc_wpart","merit_perc_netw",
                                                          "merit_pref_effort","merit_pref_talent",
                                                          "merit_pref_wpart","merit_pref_netw"))


#---------------------------------------------------#


cnames <- c("Factor","Indicator","Loading (MLR)","Loading (DWLS)")

kable(left_join(x = standardizedsolution(m_merit.4.fit) %>% filter(op=="=~") %>% dplyr::select(lhs,rhs,est.std),y = standardizedsolution(m_merit.4_ord.fit) %>% filter(op=="=~") %>% dplyr::select(lhs,rhs,est.std),c("lhs","rhs")),
      format = "markdown",digits = 2,col.names = cnames, caption = "Factor loadings")
```
